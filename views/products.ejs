<%- include('./partials/header') %>

<style>
  @keyframes slideIn {
    0% { transform: translateX(100%); opacity: 0; }
    100% { transform: translateX(0); opacity: 1; }
  }
  .animate-slideIn {
    animation: slideIn 0.3s ease forwards;
  }

  /* Responsive tweaks */
  @media (max-width: 1024px) {
    aside { position: relative !important; top: auto !important; width: 100%; margin-bottom: 2rem; }
    #products-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  }

  @media (max-width: 640px) {
    section { padding: 4rem 1.5rem; }
    .product-card img { height: 200px; }
    .product-card button { padding: 0.8rem; font-size: 0.9rem; }
  }
</style>

<section class="pt-32 pb-24 px-6 min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500">
  <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-10">
    
    <!-- ================= FILTERS ================= -->
    <aside class="w-full lg:w-64 bg-white/20 p-6 rounded-3xl backdrop-blur-md sticky top-32 h-max">
      <h2 class="text-2xl font-bold text-white mb-6">Filter Products</h2>

      <!-- PRICE -->
      <div class="mb-6">
        <h3 class="font-semibold text-white mb-2">Price Range</h3>
        <div class="flex gap-2">
          <input id="minPrice" type="number" placeholder="Min" class="w-1/2 p-2 rounded text-black">
          <input id="maxPrice" type="number" placeholder="Max" class="w-1/2 p-2 rounded text-black">
        </div>
      </div>

      <!-- DISCOUNT -->
      <div class="mb-6">
        <h3 class="font-semibold text-white mb-2">Discount</h3>
        <label class="flex gap-2 text-white">
          <input type="checkbox" value="10" class="discount-filter"> 2% or more
        </label>
        <label class="flex gap-2 text-white">
          <input type="checkbox" value="20" class="discount-filter"> 5% or more
        </label>
        <label class="flex gap-2 text-white">
          <input type="checkbox" value="30" class="discount-filter"> 10% or more
        </label>
      </div>

      <!-- CATEGORY -->
      <div class="mb-6">
        <h3 class="font-semibold text-white mb-3">Category</h3>
        <label class="flex gap-2 text-white mb-2">
          <input type="checkbox" value="mobiles" class="category-filter"> üì± Mobiles
        </label>
        <label class="flex gap-2 text-white mb-2">
          <input type="checkbox" value="laptops" class="category-filter"> üíª Laptops
        </label>
        <label class="flex gap-2 text-white mb-2">
          <input type="checkbox" value="headphones" class="category-filter"> üéß Headphones
        </label>
        <label class="flex gap-2 text-white mb-2">
          <input type="checkbox" value="accessories" class="category-filter"> üîå Accessories
        </label>
        <label class="flex gap-2 text-white mb-2">
          <input type="checkbox" value="smartwatches" class="category-filter"> ‚åö Smart Watches
        </label>
        <label class="flex gap-2 text-white">
          <input type="checkbox" value="gaming" class="category-filter"> üéÆ Gaming
        </label>
      </div>

      <button id="applyFilter" class="w-full py-2 rounded-xl bg-yellow-400 font-semibold hover:shadow-lg">
        Apply Filters
      </button>
    </aside>

    <!-- ================= PRODUCTS ================= -->
    <% 
      const defaultBg = "#0f172a";
      const defaultPanel = "#020617";
      const defaultText = "#e5e7eb";
    %>

    <div class="flex-1">
      <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-10">
        <% products.forEach(product => { %>
          <div
            onclick="openProduct('<%= product._id %>')"
            class="product-card cursor-pointer rounded-3xl shadow-2xl overflow-hidden hover:-translate-y-2 transition-all duration-300"
            style="background:<%= product.bgColor || defaultBg %>"
            data-price="<%= product.finalPrice %>"
            data-discount="<%= product.discount %>"
            data-category="<%= product.category %>"
          >
            <!-- IMAGE -->
            <div class="p-6">
              <img src="<%= product.images[0] %>" class="w-full h-56 sm:h-48 md:h-56 rounded-2xl object-cover">
            </div>

            <!-- DETAILS PANEL -->
            <div class="p-6 rounded-t-3xl flex flex-col gap-4"
                 style="background:<%= product.panelColor || defaultPanel %>; color:<%= product.textColor || defaultText %>">
              <h3 class="text-xl font-bold"><%= product.name %></h3>

              <div class="flex gap-3 items-center">
                <span class="text-2xl font-extrabold">‚Çπ<%= product.finalPrice %></span>
                <% if(product.discount > 0){ %>
                  <span class="line-through opacity-60">‚Çπ<%= product.price %></span>
                  <span class="text-green-500 font-semibold"><%= product.discount %>% OFF</span>
                <% } %>
              </div>

              <button
                onclick="event.stopPropagation(); addToCart('<%= product._id %>')"
                class="w-full py-3 rounded-2xl font-semibold bg-gradient-to-r from-yellow-300 to-orange-400 hover:scale-105 transition flex items-center justify-center gap-2">
                üõí Add to Cart
              </button>
            </div>
          </div>
        <% }) %>
      </div>

      <div id="no-products" class="hidden text-center py-20 text-white">
        <h2 class="text-xl font-semibold">Product Not Found</h2>
        <p class="opacity-80 mt-2">Try changing filters</p>
      </div>
    </div>

  </div>
</section>

<!-- TOAST -->
<div id="toast-container" class="fixed top-6 right-6 space-y-2 z-50"></div>

<script>
  /* FILTER */
  document.getElementById("applyFilter").addEventListener("click", () => {
    const min = Number(minPrice.value) || 0;
    const max = Number(maxPrice.value) || Infinity;

    const discounts = [...document.querySelectorAll(".discount-filter:checked")].map(d => +d.value);
    const categories = [...document.querySelectorAll(".category-filter:checked")].map(c => c.value);

    let visible = false;

    document.querySelectorAll(".product-card").forEach(card => {
      const price = +card.dataset.price;
      const discount = +card.dataset.discount;
      const category = card.dataset.category;

      let show = true;
      if(price < min || price > max) show = false;
      if(discounts.length && !discounts.some(d => discount >= d)) show = false;
      if(categories.length && !categories.includes(category)) show = false;

      card.style.display = show ? "block" : "none";
      if(show) visible = true;
    });

    document.getElementById("no-products").classList.toggle("hidden", visible);
  });

  /* OPEN PRODUCT PAGE */
  function openProduct(id){
    window.location.href = `/products/product/${id}`;
  }

  /* ADD TO CART */
  async function addToCart(id){
    try{
      const res = await fetch(`/cart/add/${id}`, { method:"POST" });
      const data = await res.json();
      showToast(data.success ? "Added to cart" : data.message, data.success ? "success":"error");
    }catch{
      showToast("Please login first","error");
    }
  }

  /* TOAST */
  function showToast(msg,type="success"){
    const t = document.createElement("div");
    t.className = `
      px-5 py-3 rounded-xl text-white shadow-xl
      flex items-center gap-2 animate-slideIn
      ${type === "error" ? "bg-red-500" : "bg-green-500"}
    `;
    t.innerHTML = `<span class="text-xl">${type==="error"?"‚ùå":"üõí"}</span><span>${msg}</span>`;
    document.getElementById("toast-container").appendChild(t);
    setTimeout(() => {
      t.classList.add("opacity-0","transition-opacity","duration-500");
      setTimeout(() => t.remove(), 500);
    }, 2500);
  }
</script>

<%- include('./partials/footer') %>
